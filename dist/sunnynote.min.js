!function(a){"function"==typeof define&&define.amd?define(["jquery"],a):a(window.jQuery)}(function(a){Array.prototype.reduce||(Array.prototype.reduce=function(a){var b,c=Object(this),d=c.length>>>0,e=0;if(2===arguments.length)b=arguments[1];else{for(;d>e&&!(e in c);)e++;if(e>=d)throw new TypeError("Reduce of empty array with no initial value");b=c[e++]}for(;d>e;e++)e in c&&(b=a(b,c[e],e,c));return b}),"function"!=typeof Array.prototype.filter&&(Array.prototype.filter=function(a){for(var b=Object(this),c=b.length>>>0,d=[],e=arguments.length>=2?arguments[1]:void 0,f=0;c>f;f++)if(f in b){var g=b[f];a.call(e,g,f,b)&&d.push(g)}return d});var b="function"==typeof define&&define.amd,c={isMac:navigator.appVersion.indexOf("Mac")>-1,isMSIE:navigator.userAgent.indexOf("MSIE")>-1||navigator.userAgent.indexOf("Trident")>-1,isFF:navigator.userAgent.indexOf("Firefox")>-1,jqueryVersion:parseFloat(a.fn.jquery),isSupportAmd:b,isW3CRangeSupport:!!document.createRange},d=function(){var b=function(a){return function(b){return a===b}},c=function(a,b){return a===b},d=function(a){return function(b,c){return b[a]===c[a]}},e=function(){return!0},f=function(){return!1},g=function(a){return function(){return!a.apply(a,arguments)}},h=function(a,b){return function(c){return a(c)&&b(c)}},i=function(a){return a},j=0,k=function(a){var b=++j+"";return a?a+b:b},l=function(b){var c=a(document);return{top:b.top+c.scrollTop(),left:b.left+c.scrollLeft(),width:b.right-b.left,height:b.bottom-b.top}},m=function(a){var b={};for(var c in a)a.hasOwnProperty(c)&&(b[a[c]]=c);return b};return{eq:b,eq2:c,peq2:d,ok:e,fail:f,self:i,not:g,and:h,uniqueId:k,rect2bnd:l,invertObject:m}}(),e=function(){var b=function(a){return a[0]},c=function(a){return a[a.length-1]},e=function(a){return a.slice(0,a.length-1)},f=function(a){return a.slice(1)},g=function(a,b){for(var c=0,d=a.length;d>c;c++){var e=a[c];if(b(e))return e}},h=function(a,b){for(var c=0,d=a.length;d>c;c++)if(!b(a[c]))return!1;return!0},i=function(b,c){return-1!==a.inArray(c,b)},j=function(a,b){return b=b||d.self,a.reduce(function(a,c){return a+b(c)},0)},k=function(a){for(var b=[],c=-1,d=a.length;++c<d;)b[c]=a[c];return b},l=function(a,d){if(!a.length)return[];var e=f(a);return e.reduce(function(a,b){var e=c(a);return d(c(e),b)?e[e.length]=b:a[a.length]=[b],a},[[b(a)]])},m=function(a){for(var b=[],c=0,d=a.length;d>c;c++)a[c]&&b.push(a[c]);return b},n=function(a){for(var b=[],c=0,d=a.length;d>c;c++)i(b,a[c])||b.push(a[c]);return b},o=function(a,b){var c=a.indexOf(b);return-1===c?null:a[c+1]},p=function(a,b){var c=a.indexOf(b);return-1===c?null:a[c-1]};return{head:b,last:c,initial:e,tail:f,prev:p,next:o,find:g,contains:i,all:h,sum:j,from:k,clusterBy:l,compact:m,unique:n}}(),f=String.fromCharCode(160),g="\ufeff",h=function(){var b=function(b){return b&&a(b).hasClass("note-editable")},i=function(a){var b;return b=function(b){return function(){return a.find(b)}},{editor:function(){return a},holder:function(){return a.data("holder")},editable:b(".note-editable")}},j=function(a){return a=a.toUpperCase(),function(b){return b&&b.nodeName.toUpperCase()===a}},k=function(a){return a&&3===a.nodeType},l=function(a){return a&&/^BR|^IMG|^HR/.test(a.nodeName.toUpperCase())},m=function(a){return b(a)?!1:a&&/^DIV|^P|^LI|^H[1-7]/.test(a.nodeName.toUpperCase())},n=function(a){return!o(a)&&!m(a)},o=function(a){return b(a)},p=function(a){return n(a)&&!!y(a,m)},q=function(a){return n(a)&&!y(a,m)},r=j("BODY"),s=function(a,b){return a.nextSibling===b||a.previousSibling===b},t=function(a,b){b=b||d.ok;var c=[];return a.previousSibling&&b(a.previousSibling)&&c.push(a.previousSibling),c.push(a),a.nextSibling&&b(a.nextSibling)&&c.push(a.nextSibling),c},u=c.isMSIE?"&nbsp;":"<br>",v=function(a){return k(a)?a.nodeValue.length:a.childNodes.length},w=function(a){var b=v(a);return 0===b?!0:h.isText(a)||1!==b||a.innerHTML!==u?!1:!0},x=function(a){l(a)||v(a)||(a.innerHTML=u)},y=function(a,c){for(;a;){if(c(a))return a;if(b(a))break;a=a.parentNode}return null},z=function(a,c){for(a=a.parentNode;a&&1===v(a);){if(c(a))return a;if(b(a))break;a=a.parentNode}return null},A=function(a,c){c=c||d.fail;var e=[];return y(a,function(a){return b(a)||e.push(a),c(a)}),e},B=function(a,b){var c=A(a);return e.last(c.filter(b))},C=function(b,c){for(var d=A(b),e=c;e;e=e.parentNode)if(a.inArray(e,d)>-1)return e;return null},D=function(a,b){b=b||d.fail;for(var c=[];a&&!b(a);)c.push(a),a=a.previousSibling;return c},E=function(a,b){b=b||d.fail;for(var c=[];a&&!b(a);)c.push(a),a=a.nextSibling;return c},F=function(a,b){var c=[];return b=b||d.ok,function e(d){a!==d&&b(d)&&c.push(d);for(var f=0,g=d.childNodes.length;g>f;f++)e(d.childNodes[f])}(a),c},G=function(b,c){var d=b.parentNode,e=a("<"+c+">")[0];return d.insertBefore(e,b),e.appendChild(b),e},H=function(a,b){var c=b.nextSibling,d=b.parentNode;return c?d.insertBefore(a,c):d.appendChild(a),a},I=function(b,c){return a.each(c,function(a,c){b.appendChild(c)}),b},J=function(a){return 0===a.offset},K=function(a){return a.offset===v(a.node)},L=function(a){return J(a)||K(a)},M=function(a,b){for(;a&&a!==b;){if(0!==O(a))return!1;a=a.parentNode}return!0},N=function(a,b){for(;a&&a!==b;){if(O(a)!==v(a.parentNode)-1)return!1;a=a.parentNode}return!0},O=function(a){for(var b=0;a=a.previousSibling;)b+=1;return b},P=function(a){return!!(a&&a.childNodes&&a.childNodes.length)},Q=function(a,c){var d,e;if(0===a.offset){if(b(a.node))return null;d=a.node.parentNode,e=O(a.node)}else P(a.node)?(d=a.node.childNodes[a.offset-1],e=v(d)):(d=a.node,e=c?0:a.offset-1);return{node:d,offset:e}},R=function(a,c){var d,e;if(v(a.node)===a.offset){if(b(a.node))return null;d=a.node.parentNode,e=O(a.node)+1}else P(a.node)?(d=a.node.childNodes[a.offset],e=0):(d=a.node,e=c?v(a.node):a.offset+1);return{node:d,offset:e}},S=function(a,b){return a.node===b.node&&a.offset===b.offset},T=function(a){if(k(a.node)||!P(a.node)||w(a.node))return!0;var b=a.node.childNodes[a.offset-1],c=a.node.childNodes[a.offset];return b&&!l(b)||c&&!l(c)?!1:!0},U=function(a,b){for(;a;){if(b(a))return a;a=Q(a)}return null},V=function(a,b){for(;a;){if(b(a))return a;a=R(a)}return null},W=function(a,b,c,d){for(var e=a;e&&(c(e),!S(e,b));){var f=d&&a.node!==e.node&&b.node!==e.node;e=R(e,f)}},X=function(b,c){var e=A(c,d.eq(b));return a.map(e,O).reverse()},Y=function(a,b){for(var c=a,d=0,e=b.length;e>d;d++)c=c.childNodes.length<=b[d]?c.childNodes[c.childNodes.length-1]:c.childNodes[b[d]];return c},Z=function(a,b){if(k(a.node))return J(a)?a.node:K(a)?a.node.nextSibling:a.node.splitText(a.offset);var c=a.node.childNodes[a.offset],d=H(a.node.cloneNode(!1),a.node);return I(d,E(c)),b||(x(a.node),x(d)),d},$=function(a,b,c){var e=A(b.node,d.eq(a));return e.length?1===e.length?Z(b,c):e.reduce(function(a,d){var e=H(d.cloneNode(!1),d);return a===b.node&&(a=Z(b,c)),I(e,E(a)),c||(x(d),x(e)),e}):null},_=function(a,b){var c,d,f=b?m:o,g=A(a.node,f),h=e.last(g)||a.node;f(h)?(c=g[g.length-2],d=h):(c=h,d=c.parentNode);var i=c&&$(c,a,b);return{rightNode:i,container:d}},aa=function(a){return document.createElement(a)},ba=function(a){return document.createTextNode(a)},ca=function(a,b){if(a&&a.parentNode){if(a.removeNode)return a.removeNode(b);var c=a.parentNode;if(!b){var d,e,f=[];for(d=0,e=a.childNodes.length;e>d;d++)f.push(a.childNodes[d]);for(d=0,e=f.length;e>d;d++)c.insertBefore(f[d],a)}c.removeChild(a)}},da=function(a,c){for(;a&&!b(a)&&c(a);){var d=a.parentNode;ca(a),a=d}},ea=function(a,b){if(a.nodeName.toUpperCase()===b.toUpperCase())return a;var c=aa(b);return a.style.cssText&&(c.style.cssText=a.style.cssText),I(c,e.from(a.childNodes)),H(c,a),ca(a),c},fa=j("TEXTAREA"),ga=function(b,c){var d=fa(b[0])?b.val():b.html();if(c){var e=/<(\/?)(\b(?!!)[^>\s]*)(.*?)(\s*\/?>)/g;d=d.replace(e,function(a,b,c){c=c.toUpperCase();var d=/^DIV|^TD|^TH|^P|^LI|^H[1-7]/.test(c)&&!!b,e=/^BLOCKQUOTE|^TABLE|^TBODY|^TR|^HR|^UL|^OL/.test(c);return a+(d||e?"\n":"")}),d=a.trim(d)}return d},ha=function(a,b){var c=a.val();return b?c.replace(/[\n\r]/g,""):c};return{NBSP_CHAR:f,ZERO_WIDTH_NBSP_CHAR:g,blank:u,emptyPara:"<p>"+u+"</p>",makePredByNodeName:j,isEditable:b,buildLayoutInfo:i,isText:k,isVoid:l,isPara:m,isInline:n,isBodyInline:q,isBody:r,isParaInline:p,isBodyContainer:o,isDiv:j("DIV"),isBR:j("BR"),isSpan:j("SPAN"),isB:j("B"),isU:j("U"),isS:j("S"),isI:j("I"),isImg:j("IMG"),isTextarea:fa,isEmpty:w,isClosestSibling:s,withClosestSiblings:t,nodeLength:v,isLeftEdgePoint:J,isRightEdgePoint:K,isEdgePoint:L,isLeftEdgeOf:M,isRightEdgeOf:N,prevPoint:Q,nextPoint:R,isSamePoint:S,isVisiblePoint:T,prevPointUntil:U,nextPointUntil:V,walkPoint:W,ancestor:y,singleChildAncestor:z,listAncestor:A,lastAncestor:B,listNext:E,listPrev:D,listDescendant:F,commonAncestor:C,wrap:G,insertAfter:H,appendChildNodes:I,position:O,hasChildren:P,makeOffsetPath:X,fromOffsetPath:Y,splitTree:$,splitPoint:_,create:aa,createText:ba,remove:ca,removeWhile:da,replace:ea,html:ga,value:ha}}(),i=function(){var b=function(a,b){var c,d,f=a.parentElement(),g=document.body.createTextRange(),i=e.from(f.childNodes);for(c=0;c<i.length;c++)if(!h.isText(i[c])){if(g.moveToElementText(i[c]),g.compareEndPoints("StartToStart",a)>=0)break;d=i[c]}if(0!==c&&h.isText(i[c-1])){var j=document.body.createTextRange(),k=null;j.moveToElementText(d||f),j.collapse(!d),k=d?d.nextSibling:f.firstChild;var l=a.duplicate();l.setEndPoint("StartToStart",j);for(var m=l.text.replace(/[\r\n]/g,"").length;m>k.nodeValue.length&&k.nextSibling;)m-=k.nodeValue.length,k=k.nextSibling;{k.nodeValue}b&&k.nextSibling&&h.isText(k.nextSibling)&&m===k.nodeValue.length&&(m-=k.nodeValue.length,k=k.nextSibling),f=k,c=m}return{cont:f,offset:c}},f=function(a){var b=function(a,c){var f,g;if(h.isText(a)){var i=h.listPrev(a,d.not(h.isText)),j=e.last(i).previousSibling;f=j||a.parentNode,c+=e.sum(e.tail(i),h.nodeLength),g=!j}else{if(f=a.childNodes[c]||a,h.isText(f))return b(f,0);c=0,g=!1}return{node:f,collapseToStart:g,offset:c}},c=document.body.createTextRange(),f=b(a.node,a.offset);return c.moveToElementText(f.node),c.collapse(f.collapseToStart),c.moveStart("character",f.offset),c},g=function(b,i,j,k){this.sc=b,this.so=i,this.ec=j,this.eo=k;var l=function(){if(c.isW3CRangeSupport){var a=document.createRange();return a.setStart(b,i),a.setEnd(j,k),a}var d=f({node:b,offset:i});return d.setEndPoint("EndToEnd",f({node:j,offset:k})),d};this.getPoints=function(){return{sc:b,so:i,ec:j,eo:k}},this.getStartPoint=function(){return{node:b,offset:i}},this.getEndPoint=function(){return{node:j,offset:k}},this.select=function(){var a=l();if(c.isW3CRangeSupport){var b=document.getSelection();b.rangeCount>0&&b.removeAllRanges(),b.addRange(a)}else a.select()},this.normalize=function(){var a=function(a){return h.isVisiblePoint(a)||(a=h.isLeftEdgePoint(a)?h.nextPointUntil(a,h.isVisiblePoint):h.prevPointUntil(a,h.isVisiblePoint)),a},b=a(this.getStartPoint()),c=a(this.getEndPoint());return new g(b.node,b.offset,c.node,c.offset)},this.nodes=function(a,b){a=a||d.ok;var c=b&&b.includeAncestor,f=b&&b.fullyContains,g=this.getStartPoint(),i=this.getEndPoint(),j=[],k=[];return h.walkPoint(g,i,function(b){if(!h.isEditable(b.node)){var d;f?(h.isLeftEdgePoint(b)&&k.push(b.node),h.isRightEdgePoint(b)&&e.contains(k,b.node)&&(d=b.node)):d=c?h.ancestor(b.node,a):b.node,d&&a(d)&&j.push(d)}},!0),e.unique(j)},this.commonAncestor=function(){return h.commonAncestor(b,j)},this.expand=function(a){var c=h.ancestor(b,a),d=h.ancestor(j,a);if(!c&&!d)return new g(b,i,j,k);var e=this.getPoints();return c&&(e.sc=c,e.so=0),d&&(e.ec=d,e.eo=h.nodeLength(d)),new g(e.sc,e.so,e.ec,e.eo)},this.collapse=function(a){return a?new g(b,i,b,i):new g(j,k,j,k)},this.splitText=function(){var a=b===j,c=this.getPoints();return h.isText(j)&&!h.isEdgePoint(this.getEndPoint())&&j.splitText(k),h.isText(b)&&!h.isEdgePoint(this.getStartPoint())&&(c.sc=b.splitText(i),c.so=0,a&&(c.ec=c.sc,c.eo=k-i)),new g(c.sc,c.so,c.ec,c.eo)},this.deleteContents=function(){if(this.isCollapsed())return this;var b=this.splitText(),c=b.nodes(null,{fullyContains:!0}),d=h.prevPointUntil(b.getStartPoint(),function(a){return!e.contains(c,a.node)}),f=[];return a.each(c,function(a,b){var c=b.parentNode;d.node!==c&&1===h.nodeLength(c)&&f.push(c),h.remove(b,!1)}),a.each(f,function(a,b){h.remove(b,!1)}),new g(d.node,d.offset,d.node,d.offset).normalize()};var m=function(a){return function(){var c=h.ancestor(b,a);return!!c&&c===h.ancestor(j,a)}};this.isOnEditable=m(h.isEditable),this.isLeftEdgeOf=function(a){if(!h.isLeftEdgePoint(this.getStartPoint()))return!1;var b=h.ancestor(this.sc,a);return b&&h.isLeftEdgeOf(this.sc,b)},this.isCollapsed=function(){return b===j&&i===k},this.wrapBodyInlineWithPara=function(){if(h.isBodyContainer(b)&&h.isEmpty(b))return b.innerHTML=h.emptyPara,new g(b.firstChild,0,b.firstChild,0);if(h.isParaInline(b)||h.isPara(b))return this.normalize();var a;if(h.isInline(b)){var c=h.listAncestor(b,d.not(h.isInline));a=e.last(c),h.isInline(a)||(a=c[c.length-2]||b.childNodes[i])}else a=b.childNodes[i>0?i-1:0];var f=h.listPrev(a,h.isParaInline).reverse();if(f=f.concat(h.listNext(a.nextSibling,h.isParaInline)),f.length){var j=h.wrap(e.head(f),"p");h.appendChildNodes(j,e.tail(f))}return this.normalize()},this.insertNode=function(a){var b=this.wrapBodyInlineWithPara().deleteContents(),c=h.splitPoint(b.getStartPoint(),h.isInline(a));return c.rightNode?c.rightNode.parentNode.insertBefore(a,c.rightNode):c.container.appendChild(a),a},this.toString=function(){var a=l();return c.isW3CRangeSupport?a.toString():a.text},this.bookmark=function(a){return{s:{path:h.makeOffsetPath(a,b),offset:i},e:{path:h.makeOffsetPath(a,j),offset:k}}},this.paraBookmark=function(a){return{s:{path:e.tail(h.makeOffsetPath(e.head(a),b)),offset:i},e:{path:e.tail(h.makeOffsetPath(e.last(a),j)),offset:k}}},this.getClientRects=function(){var a=l();return a.getClientRects()}};return{create:function(a,d,e,f){if(arguments.length)2===arguments.length&&(e=a,f=d);else if(c.isW3CRangeSupport){var i=document.getSelection();if(0===i.rangeCount)return null;if(h.isBody(i.anchorNode))return null;var j=i.getRangeAt(0);a=j.startContainer,d=j.startOffset,e=j.endContainer,f=j.endOffset}else{var k=document.selection.createRange(),l=k.duplicate();l.collapse(!1);var m=k;m.collapse(!0);var n=b(m,!0),o=b(l,!1);h.isText(n.node)&&h.isLeftEdgePoint(n)&&h.isTextNode(o.node)&&h.isRightEdgePoint(o)&&o.node.nextSibling===n.node&&(n=o),a=n.cont,d=n.offset,e=o.cont,f=o.offset}return new g(a,d,e,f)},createFromNode:function(a){var b=a,c=0,d=a,e=h.nodeLength(d);return h.isVoid(b)&&(c=h.listPrev(b).length-1,b=b.parentNode),h.isBR(d)?(e=h.listPrev(d).length-1,d=d.parentNode):h.isVoid(d)&&(e=h.listPrev(d).length,d=d.parentNode),this.create(b,c,d,e)},createFromBookmark:function(a,b){var c=h.fromOffsetPath(a,b.s.path),d=b.s.offset,e=h.fromOffsetPath(a,b.e.path),f=b.e.offset;return new g(c,d,e,f)},createFromParaBookmark:function(a,b){var c=a.s.offset,d=a.e.offset,f=h.fromOffsetPath(e.head(b),a.s.path),i=h.fromOffsetPath(e.last(b),a.e.path);return new g(f,c,i,d)}}}(),j={version:"0.0.1",options:{width:null,height:null,minHeight:null,maxHeight:null,focus:!1,tabsize:4,styleWithSpan:!0,shortcuts:!0,direction:null,oninit:null,onfocus:null,onblur:null,onenter:null,onkeyup:null,onkeydown:null,onsubmit:null,keyMap:{pc:{ENTER:"insertParagraph","CTRL+Z":"undo","CTRL+Y":"redo","CTRL+B":"bold","CTRL+I":"italic","CTRL+U":"underline"},mac:{ENTER:"insertParagraph","CMD+Z":"undo","CMD+SHIFT+Z":"redo","CMD+B":"bold","CMD+I":"italic","CMD+U":"underline"}}}},k={isEdit:function(a){return e.contains([8,9,13,32],a)},nameFromCode:{8:"BACKSPACE",9:"TAB",13:"ENTER",32:"SPACE",48:"NUM0",49:"NUM1",50:"NUM2",51:"NUM3",52:"NUM4",53:"NUM5",54:"NUM6",55:"NUM7",56:"NUM8",66:"B",69:"E",73:"I",74:"J",75:"K",76:"L",82:"R",83:"S",85:"U",89:"Y",90:"Z",191:"SLASH",219:"LEFTBRACKET",220:"BACKSLASH",221:"RIGHTBRACKET"}},l=function(a){var b=[],c=-1,d=a[0],e=function(){var b=i.create(),c={s:{path:[],offset:0},e:{path:[],offset:0}};return{contents:a.html(),bookmark:b?b.bookmark(d):c}},f=function(b){null!==b.contents&&a.html(b.contents),null!==b.bookmark&&i.createFromBookmark(d,b.bookmark).select()};this.undo=function(){c>0&&(c--,f(b[c]))},this.redo=function(){b.length-1>c&&(c++,f(b[c]))},this.recordUndo=function(){c++,b.length>c&&(b=b.slice(0,c)),b.push(e())},this.recordUndo()},m=function(){var b=function(b,d){if(c.jqueryVersion<1.9){var e={};return a.each(d,function(a,c){e[c]=b.css(c)}),e}return b.css.call(b,d)};this.stylePara=function(b,c){a.each(b.nodes(h.isPara,{includeAncestor:!0}),function(b,d){a(d).css(c)})},this.styleNodes=function(b,c){b=b.splitText();var f=c&&c.nodeName||"SPAN",g=!(!c||!c.expandClosestSibling),i=!(!c||!c.onlyPartialContains);if(b.isCollapsed())return b.insertNode(h.create(f));var j=h.makePredByNodeName(f),k=a.map(b.nodes(h.isText,{fullyContains:!0}),function(a){return h.singleChildAncestor(a,j)||h.wrap(a,f)});if(g){if(i){var l=b.nodes();j=d.and(j,function(a){return e.contains(l,a)})}return a.map(k,function(b){var c=h.withClosestSiblings(b,j),d=e.head(c),f=e.tail(c);return a.each(f,function(a,b){h.appendChildNodes(d,b.childNodes),h.remove(b)}),e.head(c)})}return k},this.current=function(c,d){var e=a(h.isText(c.sc)?c.sc.parentNode:c.sc),f=["font-family","font-size","text-align","list-style-type","line-height"],g=b(e,f)||{};if(g["font-size"]=parseInt(g["font-size"],10),g["font-bold"]=document.queryCommandState("bold")?"bold":"normal",g["font-italic"]=document.queryCommandState("italic")?"italic":"normal",g["font-underline"]=document.queryCommandState("underline")?"underline":"normal",g["font-strikethrough"]=document.queryCommandState("strikeThrough")?"strikethrough":"normal",g["font-superscript"]=document.queryCommandState("superscript")?"superscript":"normal",g["font-subscript"]=document.queryCommandState("subscript")?"subscript":"normal",c.isOnList()){var i=["circle","disc","disc-leading-zero","square"],j=a.inArray(g["list-style-type"],i)>-1;g["list-style"]=j?"unordered":"ordered"}else g["list-style"]="none";var k=h.ancestor(c.sc,h.isPara);if(k&&k.style["line-height"])g["line-height"]=k.style.lineHeight;else{var l=parseInt(g["line-height"],10)/parseInt(g["font-size"],10);g["line-height"]=l.toFixed(1)}return g.image=h.isImg(d)&&d,g.anchor=c.isOnAnchor()&&h.ancestor(c.sc,h.isAnchor),g.ancestors=h.listAncestor(c.sc,h.isEditable),g.range=c,g}},n=function(){this.insertTab=function(a,b,c){var d=h.createText(new Array(c+1).join(h.NBSP_CHAR));b=b.deleteContents(),b.insertNode(d,!0),b=i.create(d,c),b.select()},this.insertParagraph=function(){var b=i.create();b=b.deleteContents(),b=b.wrapBodyInlineWithPara();var c,d=h.ancestor(b.sc,h.isPara);if(d)c=h.splitTree(d,b.getStartPoint());else{var e=b.sc.childNodes[b.so];c=a(h.emptyPara)[0],e?b.sc.insertBefore(c,e):b.sc.appendChild(c)}i.create(c,0).normalize().select()}},o=function(){var a=new m,b=new n;this.createRange=function(a){return a.focus(),i.create()},this.saveRange=function(a,b){a.focus(),a.data("range",i.create()),b&&i.create().collapse().select()},this.saveNode=function(a){for(var b=[],c=0,d=a[0].childNodes.length;d>c;c++)b.push(a[0].childNodes[c]);a.data("childNodes",b)},this.restoreRange=function(a){var b=a.data("range");b&&(b.select(),a.focus())},this.restoreNode=function(a){a.html("");for(var b=a.data("childNodes"),c=0,d=b.length;d>c;c++)a[0].appendChild(b[c])},this.currentStyle=function(b){var c=i.create();return c?c.isOnEditable()&&a.current(c,b):!1};var d=this.triggerOnBeforeChange=function(a){var b=a.data("callbacks").onBeforeChange;b&&b(a.html(),a)},e=this.triggerOnChange=function(a){var b=a.data("callbacks").onChange;b&&b(a.html(),a)};this.undo=function(a){d(a),a.data("NoteHistory").undo(),e(a)},this.redo=function(a){d(a),a.data("NoteHistory").redo(),e(a)};for(var f=this.beforeCommand=function(a){d(a)},g=this.afterCommand=function(a){a.data("NoteHistory").recordUndo(),e(a)},j=["bold","italic","underline"],k=0,l=j.length;l>k;k++)this[j[k]]=function(a){return function(b,c){f(b),document.execCommand(a,!1,c),g(b)}}(j[k]);this.insertParagraph=function(a){f(a),b.insertParagraph(a),g(a)},this.insertNode=function(a,b){f(a);var c=this.createRange(a);c.insertNode(b),i.createFromNode(b).collapse().select(),g(a)},this.insertText=function(a,b){f(a);var c=this.createRange(a),d=c.insertNode(h.createText(b));i.create(d,h.nodeLength(d)).select(),g(a)},this.formatBlock=function(a,b){f(a),b=c.isMSIE?"<"+b+">":b,document.execCommand("FormatBlock",!1,b),g(a)},this.formatPara=function(a){f(a),this.formatBlock(a,"P"),g(a)},this.focus=function(a){a.focus()}},p=function(){var a=this.modules={editor:new o(this)};this.invoke=function(){var a=e.head(e.from(arguments)),b=e.tail(e.from(arguments)),c=a.split("."),d=c.length>1,f=d&&e.head(c),g=d?e.last(c):e.head(c),h=this.getModule(f),i=h[g];return i&&i.apply(h,b)},this.getModule=function(a){return this.modules[a]||this.modules.editor};var b=function(a,b){return function(){return a.trigger("sunnynote."+b,arguments)}};this.bindKeyMap=function(b,c){var d=b.editor(),e=b.editable();e.on("keydown",function(b){var f=[];b.metaKey&&f.push("CMD"),b.ctrlKey&&!b.altKey&&f.push("CTRL"),b.shiftKey&&f.push("SHIFT");var g=k.nameFromCode[b.keyCode];g&&f.push(g);var h=c[f.join("+")];h?a.editor[h]&&(a.editor[h](e,d.data("options")),b.preventDefault()):k.isEdit(b.keyCode)&&a.editor.afterCommand(e)})},this.attach=function(b,d){d.shortcuts&&this.bindKeyMap(b,d.keyMap[c.isMac?"mac":"pc"]),b.editor().data("options",d),c.isMSIE||setTimeout(function(){document.execCommand("styleWithCSS",0,d.styleWithSpan)},0);var f=new l(b.editable());if(b.editable().data("NoteHistory",f),d.onenter&&b.editable().keypress(function(a){a.keyCode===k.ENTER&&d.onenter(a)}),d.onfocus&&b.editable().focus(d.onfocus),d.onblur&&b.editable().blur(d.onblur),d.onkeyup&&b.editable().keyup(d.onkeyup),d.onkeydown&&b.editable().keydown(d.onkeydown),d.onpaste&&b.editable().on("paste",d.onpaste),d.onChange){var g=function(){a.editor.triggerOnChange(b.editable())};if(c.isMSIE){var i="DOMCharacterDataModified DOMSubtreeModified DOMNodeInserted";b.editable().on(i,g)}else b.editable().on("input",g)}b.editable().data("callbacks",{onBeforeChange:d.onBeforeChange,onChange:d.onChange}),h.isTextarea(e.head(b.holder()))&&b.holder().closest("form").submit(function(){var a=b.holder().code();b.holder().val(a),d.onsubmit&&d.onsubmit(a)})},this.attachCustomEvent=function(a){var d=a.holder(),f=a.editable();if(f.on("mousedown",b(d,"mousedown")),f.on("keyup mouseup",b(d,"update")),f.on("scroll",b(d,"scroll")),f.keypress(function(a){a.keyCode===k.ENTER&&b(d,"enter").call(this,a)}),f.focus(b(d,"focus")),f.blur(b(d,"blur")),f.keyup(b(d,"keyup")),f.keydown(b(d,"keydown")),f.on("paste",b(d,"paste")),c.isMSIE){var g="DOMCharacterDataModified DOMSubtreeModified DOMNodeInserted";f.on(g,b(d,"change"))}else f.on("input",b(d,"change"));h.isTextarea(e.head(d))&&d.closest("form").submit(function(a){var c=d.code();b(d,"submit").call(this,a,c)}),b(d,"init")()},this.detach=function(a){a.holder().off(),a.editable().off()}},q=function(){this.createLayoutByFrame=function(b,c){var d=a('<div class="note-editor"></div>');c.width&&d.width(c.width);var e=!b.is(":disabled"),f=a('<div class="note-editable" contentEditable="'+e+'"></div>').prependTo(d);c.height&&f.height(c.height),c.direction&&f.attr("dir",c.direction);var g=b.attr("placeholder")||c.placeholder;g&&f.attr("data-placeholder",g),f.html(h.html(b)),d.insertAfter(b),b.hide()},this.hasNoteEditor=function(a){return this.noteEditorFromHolder(a).length>0},this.noteEditorFromHolder=function(b){return b.next().hasClass("note-editor")?b.next():a()},this.createLayout=function(a,b){this.createLayoutByFrame(a,b)},this.layoutInfoFromHolder=function(a){var b=this.noteEditorFromHolder(a);if(b.length)return b.data("holder",a),h.buildLayoutInfo(b)},this.removeLayout=function(a,b){a.html(b.editable().html()),b.editor().remove(),a.show()}};a.sunnynote=a.sunnynote||{},a.extend(a.sunnynote,j);var r=new q,s=new p;a.extend(a.sunnynote,{renderer:r,eventHandler:s,core:{agent:c,dom:h,range:i}}),a.fn.extend({sunnynote:function(){var b=a.type(e.head(arguments)),c="string"===b,d="object"===b,f=d?e.head(arguments):{};f=a.extend({},a.sunnynote.options,f),this.each(function(b,c){var d=a(c);if(!r.hasNoteEditor(d)){r.createLayout(d,f);var e=r.layoutInfoFromHolder(d);s.attach(e,f),s.attachCustomEvent(e,f)}}),!c&&this.length&&f.oninit&&f.oninit();var g=this.first();if(g.length){var h=r.layoutInfoFromHolder(g);if(c){var i=e.head(e.from(arguments)),j=e.tail(e.from(arguments)),k=[i,h.editable()].concat(j);return s.invoke.apply(s,k)}f.focus&&h.editable().focus()}return this},code:function(b){if(void 0===b){var c=this.first();if(!c.length)return;var d=r.layoutInfoFromHolder(c),e=d&&d.editable();return e&&e.length?d.editable().html():h.isTextarea(c[0])?c.val():c.html()}return this.each(function(c,d){var e=r.layoutInfoFromHolder(a(d)),f=e&&e.editable();f&&f.html(b)}),this},destroy:function(){return this.each(function(b,c){var d=a(c);if(r.hasNoteEditor(d)){var e=r.layoutInfoFromHolder(d),f=e.editor().data("options");s.detach(e,f),r.removeLayout(d,e)}}),this}})});