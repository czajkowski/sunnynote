!function(a){"function"==typeof define&&define.amd?define(["jquery"],a):a(window.jQuery)}(function(a){Array.prototype.reduce||(Array.prototype.reduce=function(a){var b,c=Object(this),d=c.length>>>0,e=0;if(2===arguments.length)b=arguments[1];else{for(;d>e&&!(e in c);)e++;if(e>=d)throw new TypeError("Reduce of empty array with no initial value");b=c[e++]}for(;d>e;e++)e in c&&(b=a(b,c[e],e,c));return b}),"function"!=typeof Array.prototype.filter&&(Array.prototype.filter=function(a){for(var b=Object(this),c=b.length>>>0,d=[],e=arguments.length>=2?arguments[1]:void 0,f=0;c>f;f++)if(f in b){var g=b[f];a.call(e,g,f,b)&&d.push(g)}return d});var b="function"==typeof define&&define.amd,c=function(b){var c="Comic Sans MS"===b?"Courier New":"Comic Sans MS",d=a("<div>").css({position:"absolute",left:"-9999px",top:"-9999px",fontSize:"200px"}).text("mmmmmmmmmwwwwwww").appendTo(document.body),e=d.css("fontFamily",c).width(),f=d.css("fontFamily",b+","+c).width();return d.remove(),e!==f},d={isMac:navigator.appVersion.indexOf("Mac")>-1,isMSIE:navigator.userAgent.indexOf("MSIE")>-1||navigator.userAgent.indexOf("Trident")>-1,isFF:navigator.userAgent.indexOf("Firefox")>-1,jqueryVersion:parseFloat(a.fn.jquery),isSupportAmd:b,hasCodeMirror:b?require.specified("CodeMirror"):!!window.CodeMirror,isFontInstalled:c,isW3CRangeSupport:!!document.createRange},e=function(){var b=function(a){return function(b){return a===b}},c=function(a,b){return a===b},d=function(a){return function(b,c){return b[a]===c[a]}},e=function(){return!0},f=function(){return!1},g=function(a){return function(){return!a.apply(a,arguments)}},h=function(a,b){return function(c){return a(c)&&b(c)}},i=function(a){return a},j=0,k=function(a){var b=++j+"";return a?a+b:b},l=function(b){var c=a(document);return{top:b.top+c.scrollTop(),left:b.left+c.scrollLeft(),width:b.right-b.left,height:b.bottom-b.top}},m=function(a){var b={};for(var c in a)a.hasOwnProperty(c)&&(b[a[c]]=c);return b};return{eq:b,eq2:c,peq2:d,ok:e,fail:f,self:i,not:g,and:h,uniqueId:k,rect2bnd:l,invertObject:m}}(),f=function(){var b=function(a){return a[0]},c=function(a){return a[a.length-1]},d=function(a){return a.slice(0,a.length-1)},f=function(a){return a.slice(1)},g=function(a,b){for(var c=0,d=a.length;d>c;c++){var e=a[c];if(b(e))return e}},h=function(a,b){for(var c=0,d=a.length;d>c;c++)if(!b(a[c]))return!1;return!0},i=function(b,c){return-1!==a.inArray(c,b)},j=function(a,b){return b=b||e.self,a.reduce(function(a,c){return a+b(c)},0)},k=function(a){for(var b=[],c=-1,d=a.length;++c<d;)b[c]=a[c];return b},l=function(a,d){if(!a.length)return[];var e=f(a);return e.reduce(function(a,b){var e=c(a);return d(c(e),b)?e[e.length]=b:a[a.length]=[b],a},[[b(a)]])},m=function(a){for(var b=[],c=0,d=a.length;d>c;c++)a[c]&&b.push(a[c]);return b},n=function(a){for(var b=[],c=0,d=a.length;d>c;c++)i(b,a[c])||b.push(a[c]);return b},o=function(a,b){var c=a.indexOf(b);return-1===c?null:a[c+1]},p=function(a,b){var c=a.indexOf(b);return-1===c?null:a[c-1]};return{head:b,last:c,initial:d,tail:f,prev:p,next:o,find:g,contains:i,all:h,sum:j,from:k,clusterBy:l,compact:m,unique:n}}(),g=String.fromCharCode(160),h="\ufeff",i=function(){var b=function(b){return b&&a(b).hasClass("note-editable")},c=function(b){return b&&a(b).hasClass("note-control-sizing")},j=function(b){var c;if(b.hasClass("note-air-editor")){var d=f.last(b.attr("id").split("-"));return c=function(b){return function(){return a(b+d)}},{editor:function(){return b},holder:function(){return b.data("holder")},editable:function(){return b},popover:c("#note-popover-"),handle:c("#note-handle-"),dialog:c("#note-dialog-")}}return c=function(a){return function(){return b.find(a)}},{editor:function(){return b},holder:function(){return b.data("holder")},dropzone:c(".note-dropzone"),toolbar:c(".note-toolbar"),editable:c(".note-editable"),codable:c(".note-codable"),statusbar:c(".note-statusbar"),popover:c(".note-popover"),handle:c(".note-handle"),dialog:c(".note-dialog")}},k=function(b){var c=a(b).closest(".note-editor, .note-air-editor, .note-air-layout");if(!c.length)return null;var d;return d=c.is(".note-editor, .note-air-editor")?c:a("#note-editor-"+f.last(c.attr("id").split("-"))),j(d)},l=function(a){return a=a.toUpperCase(),function(b){return b&&b.nodeName.toUpperCase()===a}},m=function(a){return a&&3===a.nodeType},n=function(a){return a&&/^BR|^IMG|^HR/.test(a.nodeName.toUpperCase())},o=function(a){return b(a)?!1:a&&/^DIV|^P|^LI|^H[1-7]/.test(a.nodeName.toUpperCase())},p=l("LI"),q=function(a){return o(a)&&!p(a)},r=l("TABLE"),s=function(a){return!(w(a)||t(a)||o(a)||r(a)||v(a))},t=function(a){return a&&/^UL|^OL/.test(a.nodeName.toUpperCase())},u=function(a){return a&&/^TD|^TH/.test(a.nodeName.toUpperCase())},v=l("BLOCKQUOTE"),w=function(a){return u(a)||v(a)||b(a)},x=l("A"),y=function(a){return s(a)&&!!H(a,o)},z=function(a){return s(a)&&!H(a,o)},A=l("BODY"),B=function(a,b){return a.nextSibling===b||a.previousSibling===b},C=function(a,b){b=b||e.ok;var c=[];return a.previousSibling&&b(a.previousSibling)&&c.push(a.previousSibling),c.push(a),a.nextSibling&&b(a.nextSibling)&&c.push(a.nextSibling),c},D=d.isMSIE?"&nbsp;":"<br>",E=function(a){return m(a)?a.nodeValue.length:a.childNodes.length},F=function(a){var b=E(a);return 0===b?!0:i.isText(a)||1!==b||a.innerHTML!==D?!1:!0},G=function(a){n(a)||E(a)||(a.innerHTML=D)},H=function(a,c){for(;a;){if(c(a))return a;if(b(a))break;a=a.parentNode}return null},I=function(a,c){for(a=a.parentNode;a&&1===E(a);){if(c(a))return a;if(b(a))break;a=a.parentNode}return null},J=function(a,c){c=c||e.fail;var d=[];return H(a,function(a){return b(a)||d.push(a),c(a)}),d},K=function(a,b){var c=J(a);return f.last(c.filter(b))},L=function(b,c){for(var d=J(b),e=c;e;e=e.parentNode)if(a.inArray(e,d)>-1)return e;return null},M=function(a,b){b=b||e.fail;for(var c=[];a&&!b(a);)c.push(a),a=a.previousSibling;return c},N=function(a,b){b=b||e.fail;for(var c=[];a&&!b(a);)c.push(a),a=a.nextSibling;return c},O=function(a,b){var c=[];return b=b||e.ok,function d(e){a!==e&&b(e)&&c.push(e);for(var f=0,g=e.childNodes.length;g>f;f++)d(e.childNodes[f])}(a),c},P=function(b,c){var d=b.parentNode,e=a("<"+c+">")[0];return d.insertBefore(e,b),e.appendChild(b),e},Q=function(a,b){var c=b.nextSibling,d=b.parentNode;return c?d.insertBefore(a,c):d.appendChild(a),a},R=function(b,c){return a.each(c,function(a,c){b.appendChild(c)}),b},S=function(a){return 0===a.offset},T=function(a){return a.offset===E(a.node)},U=function(a){return S(a)||T(a)},V=function(a,b){for(;a&&a!==b;){if(0!==X(a))return!1;a=a.parentNode}return!0},W=function(a,b){for(;a&&a!==b;){if(X(a)!==E(a.parentNode)-1)return!1;a=a.parentNode}return!0},X=function(a){for(var b=0;a=a.previousSibling;)b+=1;return b},Y=function(a){return!!(a&&a.childNodes&&a.childNodes.length)},Z=function(a,c){var d,e;if(0===a.offset){if(b(a.node))return null;d=a.node.parentNode,e=X(a.node)}else Y(a.node)?(d=a.node.childNodes[a.offset-1],e=E(d)):(d=a.node,e=c?0:a.offset-1);return{node:d,offset:e}},$=function(a,c){var d,e;if(E(a.node)===a.offset){if(b(a.node))return null;d=a.node.parentNode,e=X(a.node)+1}else Y(a.node)?(d=a.node.childNodes[a.offset],e=0):(d=a.node,e=c?E(a.node):a.offset+1);return{node:d,offset:e}},_=function(a,b){return a.node===b.node&&a.offset===b.offset},aa=function(a){if(m(a.node)||!Y(a.node)||F(a.node))return!0;var b=a.node.childNodes[a.offset-1],c=a.node.childNodes[a.offset];return b&&!n(b)||c&&!n(c)?!1:!0},ba=function(a,b){for(;a;){if(b(a))return a;a=Z(a)}return null},ca=function(a,b){for(;a;){if(b(a))return a;a=$(a)}return null},da=function(a,b,c,d){for(var e=a;e&&(c(e),!_(e,b));){var f=d&&a.node!==e.node&&b.node!==e.node;e=$(e,f)}},ea=function(b,c){var d=J(c,e.eq(b));return a.map(d,X).reverse()},fa=function(a,b){for(var c=a,d=0,e=b.length;e>d;d++)c=c.childNodes.length<=b[d]?c.childNodes[c.childNodes.length-1]:c.childNodes[b[d]];return c},ga=function(a,b){if(m(a.node))return S(a)?a.node:T(a)?a.node.nextSibling:a.node.splitText(a.offset);var c=a.node.childNodes[a.offset],d=Q(a.node.cloneNode(!1),a.node);return R(d,N(c)),b||(G(a.node),G(d)),d},ha=function(a,b,c){var d=J(b.node,e.eq(a));return d.length?1===d.length?ga(b,c):d.reduce(function(a,d){var e=Q(d.cloneNode(!1),d);return a===b.node&&(a=ga(b,c)),R(e,N(a)),c||(G(d),G(e)),e}):null},ia=function(a,b){var c,d,e=b?o:w,g=J(a.node,e),h=f.last(g)||a.node;e(h)?(c=g[g.length-2],d=h):(c=h,d=c.parentNode);var i=c&&ha(c,a,b);return{rightNode:i,container:d}},ja=function(a){return document.createElement(a)},ka=function(a){return document.createTextNode(a)},la=function(a,b){if(a&&a.parentNode){if(a.removeNode)return a.removeNode(b);var c=a.parentNode;if(!b){var d,e,f=[];for(d=0,e=a.childNodes.length;e>d;d++)f.push(a.childNodes[d]);for(d=0,e=f.length;e>d;d++)c.insertBefore(f[d],a)}c.removeChild(a)}},ma=function(a,c){for(;a&&!b(a)&&c(a);){var d=a.parentNode;la(a),a=d}},na=function(a,b){if(a.nodeName.toUpperCase()===b.toUpperCase())return a;var c=ja(b);return a.style.cssText&&(c.style.cssText=a.style.cssText),R(c,f.from(a.childNodes)),Q(c,a),la(a),c},oa=l("TEXTAREA"),pa=function(b,c){var d=oa(b[0])?b.val():b.html();if(c){var e=/<(\/?)(\b(?!!)[^>\s]*)(.*?)(\s*\/?>)/g;d=d.replace(e,function(a,b,c){c=c.toUpperCase();var d=/^DIV|^TD|^TH|^P|^LI|^H[1-7]/.test(c)&&!!b,e=/^BLOCKQUOTE|^TABLE|^TBODY|^TR|^HR|^UL|^OL/.test(c);return a+(d||e?"\n":"")}),d=a.trim(d)}return d},qa=function(a,b){var c=a.val();return b?c.replace(/[\n\r]/g,""):c};return{NBSP_CHAR:g,ZERO_WIDTH_NBSP_CHAR:h,blank:D,emptyPara:"<p>"+D+"</p>",makePredByNodeName:l,isEditable:b,isControlSizing:c,buildLayoutInfo:j,makeLayoutInfo:k,isText:m,isVoid:n,isPara:o,isPurePara:q,isInline:s,isBodyInline:z,isBody:A,isParaInline:y,isList:t,isTable:r,isCell:u,isBlockquote:v,isBodyContainer:w,isAnchor:x,isDiv:l("DIV"),isLi:p,isBR:l("BR"),isSpan:l("SPAN"),isB:l("B"),isU:l("U"),isS:l("S"),isI:l("I"),isImg:l("IMG"),isTextarea:oa,isEmpty:F,isEmptyAnchor:e.and(x,F),isClosestSibling:B,withClosestSiblings:C,nodeLength:E,isLeftEdgePoint:S,isRightEdgePoint:T,isEdgePoint:U,isLeftEdgeOf:V,isRightEdgeOf:W,prevPoint:Z,nextPoint:$,isSamePoint:_,isVisiblePoint:aa,prevPointUntil:ba,nextPointUntil:ca,walkPoint:da,ancestor:H,singleChildAncestor:I,listAncestor:J,lastAncestor:K,listNext:N,listPrev:M,listDescendant:O,commonAncestor:L,wrap:P,insertAfter:Q,appendChildNodes:R,position:X,hasChildren:Y,makeOffsetPath:ea,fromOffsetPath:fa,splitTree:ha,splitPoint:ia,create:ja,createText:ka,remove:la,removeWhile:ma,replace:na,html:pa,value:qa}}(),j=function(){var b=function(a,b){var c,d,e=a.parentElement(),g=document.body.createTextRange(),h=f.from(e.childNodes);for(c=0;c<h.length;c++)if(!i.isText(h[c])){if(g.moveToElementText(h[c]),g.compareEndPoints("StartToStart",a)>=0)break;d=h[c]}if(0!==c&&i.isText(h[c-1])){var j=document.body.createTextRange(),k=null;j.moveToElementText(d||e),j.collapse(!d),k=d?d.nextSibling:e.firstChild;var l=a.duplicate();l.setEndPoint("StartToStart",j);for(var m=l.text.replace(/[\r\n]/g,"").length;m>k.nodeValue.length&&k.nextSibling;)m-=k.nodeValue.length,k=k.nextSibling;{k.nodeValue}b&&k.nextSibling&&i.isText(k.nextSibling)&&m===k.nodeValue.length&&(m-=k.nodeValue.length,k=k.nextSibling),e=k,c=m}return{cont:e,offset:c}},c=function(a){var b=function(a,c){var d,g;if(i.isText(a)){var h=i.listPrev(a,e.not(i.isText)),j=f.last(h).previousSibling;d=j||a.parentNode,c+=f.sum(f.tail(h),i.nodeLength),g=!j}else{if(d=a.childNodes[c]||a,i.isText(d))return b(d,0);c=0,g=!1}return{node:d,collapseToStart:g,offset:c}},c=document.body.createTextRange(),d=b(a.node,a.offset);return c.moveToElementText(d.node),c.collapse(d.collapseToStart),c.moveStart("character",d.offset),c},g=function(b,h,j,k){this.sc=b,this.so=h,this.ec=j,this.eo=k;var l=function(){if(d.isW3CRangeSupport){var a=document.createRange();return a.setStart(b,h),a.setEnd(j,k),a}var e=c({node:b,offset:h});return e.setEndPoint("EndToEnd",c({node:j,offset:k})),e};this.getPoints=function(){return{sc:b,so:h,ec:j,eo:k}},this.getStartPoint=function(){return{node:b,offset:h}},this.getEndPoint=function(){return{node:j,offset:k}},this.select=function(){var a=l();if(d.isW3CRangeSupport){var b=document.getSelection();b.rangeCount>0&&b.removeAllRanges(),b.addRange(a)}else a.select()},this.normalize=function(){var a=function(a){return i.isVisiblePoint(a)||(a=i.isLeftEdgePoint(a)?i.nextPointUntil(a,i.isVisiblePoint):i.prevPointUntil(a,i.isVisiblePoint)),a},b=a(this.getStartPoint()),c=a(this.getEndPoint());return new g(b.node,b.offset,c.node,c.offset)},this.nodes=function(a,b){a=a||e.ok;var c=b&&b.includeAncestor,d=b&&b.fullyContains,g=this.getStartPoint(),h=this.getEndPoint(),j=[],k=[];return i.walkPoint(g,h,function(b){if(!i.isEditable(b.node)){var e;d?(i.isLeftEdgePoint(b)&&k.push(b.node),i.isRightEdgePoint(b)&&f.contains(k,b.node)&&(e=b.node)):e=c?i.ancestor(b.node,a):b.node,e&&a(e)&&j.push(e)}},!0),f.unique(j)},this.commonAncestor=function(){return i.commonAncestor(b,j)},this.expand=function(a){var c=i.ancestor(b,a),d=i.ancestor(j,a);if(!c&&!d)return new g(b,h,j,k);var e=this.getPoints();return c&&(e.sc=c,e.so=0),d&&(e.ec=d,e.eo=i.nodeLength(d)),new g(e.sc,e.so,e.ec,e.eo)},this.collapse=function(a){return a?new g(b,h,b,h):new g(j,k,j,k)},this.splitText=function(){var a=b===j,c=this.getPoints();return i.isText(j)&&!i.isEdgePoint(this.getEndPoint())&&j.splitText(k),i.isText(b)&&!i.isEdgePoint(this.getStartPoint())&&(c.sc=b.splitText(h),c.so=0,a&&(c.ec=c.sc,c.eo=k-h)),new g(c.sc,c.so,c.ec,c.eo)},this.deleteContents=function(){if(this.isCollapsed())return this;var b=this.splitText(),c=b.nodes(null,{fullyContains:!0}),d=i.prevPointUntil(b.getStartPoint(),function(a){return!f.contains(c,a.node)}),e=[];return a.each(c,function(a,b){var c=b.parentNode;d.node!==c&&1===i.nodeLength(c)&&e.push(c),i.remove(b,!1)}),a.each(e,function(a,b){i.remove(b,!1)}),new g(d.node,d.offset,d.node,d.offset).normalize()};var m=function(a){return function(){var c=i.ancestor(b,a);return!!c&&c===i.ancestor(j,a)}};this.isOnEditable=m(i.isEditable),this.isOnList=m(i.isList),this.isOnAnchor=m(i.isAnchor),this.isOnCell=m(i.isCell),this.isLeftEdgeOf=function(a){if(!i.isLeftEdgePoint(this.getStartPoint()))return!1;var b=i.ancestor(this.sc,a);return b&&i.isLeftEdgeOf(this.sc,b)},this.isCollapsed=function(){return b===j&&h===k},this.wrapBodyInlineWithPara=function(){if(i.isBodyContainer(b)&&i.isEmpty(b))return b.innerHTML=i.emptyPara,new g(b.firstChild,0,b.firstChild,0);if(i.isParaInline(b)||i.isPara(b))return this.normalize();var a;if(i.isInline(b)){var c=i.listAncestor(b,e.not(i.isInline));a=f.last(c),i.isInline(a)||(a=c[c.length-2]||b.childNodes[h])}else a=b.childNodes[h>0?h-1:0];var d=i.listPrev(a,i.isParaInline).reverse();if(d=d.concat(i.listNext(a.nextSibling,i.isParaInline)),d.length){var j=i.wrap(f.head(d),"p");i.appendChildNodes(j,f.tail(d))}return this.normalize()},this.insertNode=function(a){var b=this.wrapBodyInlineWithPara().deleteContents(),c=i.splitPoint(b.getStartPoint(),i.isInline(a));return c.rightNode?c.rightNode.parentNode.insertBefore(a,c.rightNode):c.container.appendChild(a),a},this.toString=function(){var a=l();return d.isW3CRangeSupport?a.toString():a.text},this.bookmark=function(a){return{s:{path:i.makeOffsetPath(a,b),offset:h},e:{path:i.makeOffsetPath(a,j),offset:k}}},this.paraBookmark=function(a){return{s:{path:f.tail(i.makeOffsetPath(f.head(a),b)),offset:h},e:{path:f.tail(i.makeOffsetPath(f.last(a),j)),offset:k}}},this.getClientRects=function(){var a=l();return a.getClientRects()}};return{create:function(a,c,e,f){if(arguments.length)2===arguments.length&&(e=a,f=c);else if(d.isW3CRangeSupport){var h=document.getSelection();if(0===h.rangeCount)return null;if(i.isBody(h.anchorNode))return null;var j=h.getRangeAt(0);a=j.startContainer,c=j.startOffset,e=j.endContainer,f=j.endOffset}else{var k=document.selection.createRange(),l=k.duplicate();l.collapse(!1);var m=k;m.collapse(!0);var n=b(m,!0),o=b(l,!1);i.isText(n.node)&&i.isLeftEdgePoint(n)&&i.isTextNode(o.node)&&i.isRightEdgePoint(o)&&o.node.nextSibling===n.node&&(n=o),a=n.cont,c=n.offset,e=o.cont,f=o.offset}return new g(a,c,e,f)},createFromNode:function(a){var b=a,c=0,d=a,e=i.nodeLength(d);return i.isVoid(b)&&(c=i.listPrev(b).length-1,b=b.parentNode),i.isBR(d)?(e=i.listPrev(d).length-1,d=d.parentNode):i.isVoid(d)&&(e=i.listPrev(d).length,d=d.parentNode),this.create(b,c,d,e)},createFromBookmark:function(a,b){var c=i.fromOffsetPath(a,b.s.path),d=b.s.offset,e=i.fromOffsetPath(a,b.e.path),f=b.e.offset;return new g(c,d,e,f)},createFromParaBookmark:function(a,b){var c=a.s.offset,d=a.e.offset,e=i.fromOffsetPath(f.head(b),a.s.path),h=i.fromOffsetPath(f.last(b),a.e.path);return new g(e,c,h,d)}}}(),k={version:"0.0.1",options:{width:null,height:null,minHeight:null,maxHeight:null,focus:!1,tabsize:4,styleWithSpan:!0,shortcuts:!0,direction:null,oninit:null,onfocus:null,onblur:null,onenter:null,onkeyup:null,onkeydown:null,onsubmit:null,keyMap:{pc:{ENTER:"insertParagraph","CTRL+Z":"undo","CTRL+Y":"redo","CTRL+B":"bold","CTRL+U":"underline"},mac:{ENTER:"insertParagraph","CMD+Z":"undo","CMD+SHIFT+Z":"redo","CMD+B":"bold","CMD+U":"underline"}}}},l={isEdit:function(a){return f.contains([8,9,13,32],a)},nameFromCode:{8:"BACKSPACE",9:"TAB",13:"ENTER",32:"SPACE",48:"NUM0",49:"NUM1",50:"NUM2",51:"NUM3",52:"NUM4",53:"NUM5",54:"NUM6",55:"NUM7",56:"NUM8",66:"B",69:"E",73:"I",74:"J",75:"K",76:"L",82:"R",83:"S",85:"U",89:"Y",90:"Z",191:"SLASH",219:"LEFTBRACKET",220:"BACKSLASH",221:"RIGHTBRACKET"}},m=function(a){var b=[],c=-1,d=a[0],e=function(){var b=j.create(),c={s:{path:[],offset:0},e:{path:[],offset:0}};return{contents:a.html(),bookmark:b?b.bookmark(d):c}},f=function(b){null!==b.contents&&a.html(b.contents),null!==b.bookmark&&j.createFromBookmark(d,b.bookmark).select()};this.undo=function(){c>0&&(c--,f(b[c]))},this.redo=function(){b.length-1>c&&(c++,f(b[c]))},this.recordUndo=function(){c++,b.length>c&&(b=b.slice(0,c)),b.push(e())},this.recordUndo()},n=function(){var b=function(b,c){if(d.jqueryVersion<1.9){var e={};return a.each(c,function(a,c){e[c]=b.css(c)}),e}return b.css.call(b,c)};this.stylePara=function(b,c){a.each(b.nodes(i.isPara,{includeAncestor:!0}),function(b,d){a(d).css(c)})},this.styleNodes=function(b,c){b=b.splitText();var d=c&&c.nodeName||"SPAN",g=!(!c||!c.expandClosestSibling),h=!(!c||!c.onlyPartialContains);if(b.isCollapsed())return b.insertNode(i.create(d));var j=i.makePredByNodeName(d),k=a.map(b.nodes(i.isText,{fullyContains:!0}),function(a){return i.singleChildAncestor(a,j)||i.wrap(a,d)});if(g){if(h){var l=b.nodes();j=e.and(j,function(a){return f.contains(l,a)})}return a.map(k,function(b){var c=i.withClosestSiblings(b,j),d=f.head(c),e=f.tail(c);return a.each(e,function(a,b){i.appendChildNodes(d,b.childNodes),i.remove(b)}),f.head(c)})}return k},this.current=function(c,d){var e=a(i.isText(c.sc)?c.sc.parentNode:c.sc),f=["font-family","font-size","text-align","list-style-type","line-height"],g=b(e,f)||{};if(g["font-size"]=parseInt(g["font-size"],10),g["font-bold"]=document.queryCommandState("bold")?"bold":"normal",g["font-italic"]=document.queryCommandState("italic")?"italic":"normal",g["font-underline"]=document.queryCommandState("underline")?"underline":"normal",g["font-strikethrough"]=document.queryCommandState("strikeThrough")?"strikethrough":"normal",g["font-superscript"]=document.queryCommandState("superscript")?"superscript":"normal",g["font-subscript"]=document.queryCommandState("subscript")?"subscript":"normal",c.isOnList()){var h=["circle","disc","disc-leading-zero","square"],j=a.inArray(g["list-style-type"],h)>-1;g["list-style"]=j?"unordered":"ordered"}else g["list-style"]="none";var k=i.ancestor(c.sc,i.isPara);if(k&&k.style["line-height"])g["line-height"]=k.style.lineHeight;else{var l=parseInt(g["line-height"],10)/parseInt(g["font-size"],10);g["line-height"]=l.toFixed(1)}return g.image=i.isImg(d)&&d,g.anchor=c.isOnAnchor()&&i.ancestor(c.sc,i.isAnchor),g.ancestors=i.listAncestor(c.sc,i.isEditable),g.range=c,g}},o=function(){this.insertTab=function(a,b,c){var d=i.createText(new Array(c+1).join(i.NBSP_CHAR));b=b.deleteContents(),b.insertNode(d,!0),b=j.create(d,c),b.select()},this.insertParagraph=function(){var b=j.create();b=b.deleteContents(),b=b.wrapBodyInlineWithPara();var c,d=i.ancestor(b.sc,i.isPara);if(d){c=i.splitTree(d,b.getStartPoint());var e=i.listDescendant(d,i.isEmptyAnchor);e=e.concat(i.listDescendant(c,i.isEmptyAnchor)),a.each(e,function(a,b){i.remove(b)})}else{var f=b.sc.childNodes[b.so];c=a(i.emptyPara)[0],f?b.sc.insertBefore(c,f):b.sc.appendChild(c)}j.create(c,0).normalize().select()}},p=function(){var a=new n,b=new o;this.createRange=function(a){return a.focus(),j.create()},this.saveRange=function(a,b){a.focus(),a.data("range",j.create()),b&&j.create().collapse().select()},this.saveNode=function(a){for(var b=[],c=0,d=a[0].childNodes.length;d>c;c++)b.push(a[0].childNodes[c]);a.data("childNodes",b)},this.restoreRange=function(a){var b=a.data("range");b&&(b.select(),a.focus())},this.restoreNode=function(a){a.html("");for(var b=a.data("childNodes"),c=0,d=b.length;d>c;c++)a[0].appendChild(b[c])},this.currentStyle=function(b){var c=j.create();return c?c.isOnEditable()&&a.current(c,b):!1};var c=this.triggerOnBeforeChange=function(a){var b=a.data("callbacks").onBeforeChange;b&&b(a.html(),a)},e=this.triggerOnChange=function(a){var b=a.data("callbacks").onChange;b&&b(a.html(),a)};this.undo=function(a){c(a),a.data("NoteHistory").undo(),e(a)},this.redo=function(a){c(a),a.data("NoteHistory").redo(),e(a)};for(var f=this.beforeCommand=function(a){c(a)},g=this.afterCommand=function(a){a.data("NoteHistory").recordUndo(),e(a)},h=["bold","underline"],k=0,l=h.length;l>k;k++)this[h[k]]=function(a){return function(b,c){f(b),document.execCommand(a,!1,c),g(b)}}(h[k]);this.insertParagraph=function(a){f(a),b.insertParagraph(a),g(a)},this.insertNode=function(a,b){f(a);var c=this.createRange(a);c.insertNode(b),j.createFromNode(b).collapse().select(),g(a)},this.insertText=function(a,b){f(a);var c=this.createRange(a),d=c.insertNode(i.createText(b));j.create(d,i.nodeLength(d)).select(),g(a)},this.formatBlock=function(a,b){f(a),b=d.isMSIE?"<"+b+">":b,document.execCommand("FormatBlock",!1,b),g(a)},this.formatPara=function(a){f(a),this.formatBlock(a,"P"),g(a)},this.focus=function(a){a.focus()}},q=function(){var b=this.modules={editor:new p(this)};this.invoke=function(){var a=f.head(f.from(arguments)),b=f.tail(f.from(arguments)),c=a.split("."),d=c.length>1,e=d&&f.head(c),g=d?f.last(c):f.head(c),h=this.getModule(e),i=h[g];return i&&i.apply(h,b)},this.getModule=function(a){return this.modules[a]||this.modules.editor};var c=function(a,b){return function(){return a.trigger("sunnynote."+b,arguments)}};this.bindKeyMap=function(c,d){var e=c.editor(),f=c.editable();f.on("keydown",function(g){var h=[];g.metaKey&&h.push("CMD"),g.ctrlKey&&!g.altKey&&h.push("CTRL"),g.shiftKey&&h.push("SHIFT");var i=l.nameFromCode[g.keyCode];i&&h.push(i);var j=d[h.join("+")];if(j)if(a.sunnynote.pluginEvents[j]){var k=a.sunnynote.pluginEvents[j];a.isFunction(k)&&k(g,b.editor,c)}else b.editor[j]&&(b.editor[j](f,e.data("options")),g.preventDefault());else l.isEdit(g.keyCode)&&b.editor.afterCommand(f)})},this.attach=function(a,c){c.shortcuts&&this.bindKeyMap(a,c.keyMap[d.isMac?"mac":"pc"]),a.editor().data("options",c),d.isMSIE||setTimeout(function(){document.execCommand("styleWithCSS",0,c.styleWithSpan)},0);var e=new m(a.editable());if(a.editable().data("NoteHistory",e),c.onenter&&a.editable().keypress(function(a){a.keyCode===l.ENTER&&c.onenter(a)}),c.onfocus&&a.editable().focus(c.onfocus),c.onblur&&a.editable().blur(c.onblur),c.onkeyup&&a.editable().keyup(c.onkeyup),c.onkeydown&&a.editable().keydown(c.onkeydown),c.onpaste&&a.editable().on("paste",c.onpaste),c.onChange){var g=function(){b.editor.triggerOnChange(a.editable())};if(d.isMSIE){var h="DOMCharacterDataModified DOMSubtreeModified DOMNodeInserted";a.editable().on(h,g)}else a.editable().on("input",g)}a.editable().data("callbacks",{onBeforeChange:c.onBeforeChange,onChange:c.onChange}),i.isTextarea(f.head(a.holder()))&&a.holder().closest("form").submit(function(){var b=a.holder().code();a.holder().val(b),c.onsubmit&&c.onsubmit(b)})},this.attachCustomEvent=function(b){var e=b.holder(),g=b.editable();if(g.on("mousedown",c(e,"mousedown")),g.on("keyup mouseup",c(e,"update")),g.on("scroll",c(e,"scroll")),g.keypress(function(a){a.keyCode===l.ENTER&&c(e,"enter").call(this,a)}),g.focus(c(e,"focus")),g.blur(c(e,"blur")),g.keyup(c(e,"keyup")),g.keydown(c(e,"keydown")),g.on("paste",c(e,"paste")),d.isMSIE){var h="DOMCharacterDataModified DOMSubtreeModified DOMNodeInserted";g.on(h,c(e,"change"))}else g.on("input",c(e,"change"));i.isTextarea(f.head(e))&&e.closest("form").submit(function(a){var b=e.code();c(e,"submit").call(this,a,b)}),c(e,"init")();for(var j=0,k=a.sunnynote.plugins.length;k>j;j++)a.isFunction(a.sunnynote.plugins[j].init)&&a.sunnynote.plugins[j].init(b)},this.detach=function(a){a.holder().off(),a.editable().off()}},r=function(){this.createLayoutByFrame=function(b,c){var d=a('<div class="note-editor"></div>');c.width&&d.width(c.width);var e=!b.is(":disabled"),f=a('<div class="note-editable" contentEditable="'+e+'"></div>').prependTo(d);c.height&&f.height(c.height),c.direction&&f.attr("dir",c.direction);var g=b.attr("placeholder")||c.placeholder;g&&f.attr("data-placeholder",g),f.html(i.html(b)),d.insertAfter(b),b.hide()},this.hasNoteEditor=function(a){return this.noteEditorFromHolder(a).length>0},this.noteEditorFromHolder=function(b){return b.hasClass("note-air-editor")?b:b.next().hasClass("note-editor")?b.next():a()},this.createLayout=function(a,b){this.createLayoutByFrame(a,b)},this.layoutInfoFromHolder=function(a){var b=this.noteEditorFromHolder(a);if(b.length)return b.data("holder",a),i.buildLayoutInfo(b)},this.removeLayout=function(a,b,c){c.airMode?(a.removeClass("note-air-editor note-editable").removeAttr("id contentEditable"),b.popover().remove(),b.handle().remove(),b.dialog().remove()):(a.html(b.editable().html()),b.editor().remove(),a.show())}};a.sunnynote=a.sunnynote||{},a.extend(a.sunnynote,k);var s=new r,t=new q;a.extend(a.sunnynote,{renderer:s,eventHandler:t,core:{agent:d,dom:i,range:j},pluginEvents:{},plugins:[]}),a.sunnynote.addPlugin=function(b){a.sunnynote.plugins.push(b),b.events&&a.each(b.events,function(b,c){a.sunnynote.pluginEvents[b]=c}),b.options&&a.extend(a.sunnynote.options,b.options)},a.fn.extend({sunnynote:function(){var b=a.type(f.head(arguments)),c="string"===b,d="object"===b,e=d?f.head(arguments):{};e=a.extend({},a.sunnynote.options,e),this.each(function(b,c){var d=a(c);if(!s.hasNoteEditor(d)){s.createLayout(d,e);var f=s.layoutInfoFromHolder(d);t.attach(f,e),t.attachCustomEvent(f,e)}}),!c&&this.length&&e.oninit&&e.oninit();var g=this.first();if(g.length){var h=s.layoutInfoFromHolder(g);if(c){var i=f.head(f.from(arguments)),j=f.tail(f.from(arguments)),k=[i,h.editable()].concat(j);return t.invoke.apply(t,k)}e.focus&&h.editable().focus()}return this},code:function(b){if(void 0===b){var c=this.first();if(!c.length)return;var d=s.layoutInfoFromHolder(c),e=d&&d.editable();if(e&&e.length){var f=t.invoke("codeview.isActivated",d);return t.invoke("codeview.sync",d),f?d.codable().val():d.editable().html()}return i.isTextarea(c[0])?c.val():c.html()}return this.each(function(c,d){var e=s.layoutInfoFromHolder(a(d)),f=e&&e.editable();f&&f.html(b)}),this},destroy:function(){return this.each(function(b,c){var d=a(c);if(s.hasNoteEditor(d)){var e=s.layoutInfoFromHolder(d),f=e.editor().data("options");t.detach(e,f),s.removeLayout(d,e,f)}}),this}})});